pipeline {
    // Use agent that has aws, kubectl, docker, npm installed.
    // Change the label to the node where you installed aws-cli and kubectl (e.g. "ubuntu").
    agent { label 'ubuntu' }

    tools {
        jdk 'jdk17'        // your configured JDK tool name
        maven 'maven3'     // your configured Maven tool name
        nodejs 'nodejs25'  // your configured NodeJS tool name
    }

    environment {
        SCANNER_HOME     = tool 'sonarqube-scanner'   // name in Jenkins global tools
        DOCKER_IMAGE     = 'tejasgowramma123/bms-app:latest'
        AWS_REGION       = 'us-east-1'
        EKS_CLUSTER_NAME = 'bookmyshow-eks'

        // File created by trivy stage (attached to email)
        TRIVY_OUTPUT = 'trivyfs.txt'
    }

    stages {
        stage('Clean Workspace') {
            steps { cleanWs() }
        }

        stage('Checkout Code') {
            steps {
                git branch: 'main', url: 'https://github.com/staragile2016/Book-My-Show.git'
                sh 'ls -la'
            }
        }

        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv('sonarserver') {
                    sh """
                      ${SCANNER_HOME}/bin/sonar-scanner \
                        -Dsonar.projectKey=BMS \
                        -Dsonar.sources=bookmyshow-app \
                        -Dsonar.exclusions=**/node_modules/**
                    """
                }
            }
        }

        stage('Skip Quality Gate (Fast)') {
            steps { echo "Skipping quality gate check for faster pipeline." }
        }

        stage('Install Dependencies') {
            steps {
                dir('bookmyshow-app') {
                    sh '''
                      rm -rf node_modules package-lock.json || true
                      npm ci --silent || npm install --silent
                    '''
                }
            }
        }

        stage('OWASP Dependency-Check (scan)') {
            steps {
                // Ensure the Dependency-Check tool installation name in Jenkins is 'odc'
                // If your tool name differs, replace odc below with that name.
                script {
                    // run the dependency-check analysis (plugin step)
                    dependencyCheck additionalArguments: """
                        --scan bookmyshow-app
                        --format XML
                        --out .
                        --disableAssembly
                        --noupdate
                    """,
                    odcInstallation: 'odc'   // MUST match the Dependency-Check tool name in Manage Jenkins -> Tools
                }
            }
            post {
                always {
                    // publish the dependency-check XML if produced
                    dependencyCheckPublisher pattern: '**/dependency-check-report.xml'
                    // archive results for later inspection
                    archiveArtifacts artifacts: '**/dependency-check-report.*', allowEmptyArchive: true
                }
            }
        }

        stage('Trivy FS Scan') {
            steps {
                sh "trivy fs bookmyshow-app > ${TRIVY_OUTPUT} || true"
                archiveArtifacts artifacts: "${TRIVY_OUTPUT}", allowEmptyArchive: true
            }
        }

        stage('Docker Build & Push') {
            steps {
                script {
                    // use docker credentials configured in Jenkins (username/password)
                    withDockerRegistry(credentialsId: 'docker-creds') {
                        sh """
                          docker build -t ${DOCKER_IMAGE} -f bookmyshow-app/Dockerfile bookmyshow-app
                          docker push ${DOCKER_IMAGE}
                        """
                    }
                }
            }
        }

        stage('Deploy to EKS') {
            steps {
                // Use the AWS creds stored in Jenkins (must be stored as username=AWS_ACCESS_KEY_ID, password=AWS_SECRET_ACCESS_KEY)
                // Replace 'aws-creds' with your credentials ID if different.
                withCredentials([usernamePassword(credentialsId: 'aws-creds',
                                                  usernameVariable: 'AWS_ACCESS_KEY_ID',
                                                  passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                    sh '''
                      set -x
                      # Export AWS credentials for aws-cli
                      export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
                      export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
                      export AWS_DEFAULT_REGION=${AWS_REGION}

                      # Update kubeconfig for the cluster (adds context to ~/.kube/config)
                      aws eks update-kubeconfig --region ${AWS_REGION} --name ${EKS_CLUSTER_NAME}

                      # Optionally confirm context
                      kubectl config current-context

                      # Apply deployment and service manifests (adjust paths if your manifests are in repo)
                      kubectl apply -f bookmyshow-app/deployment.yml || true
                      kubectl apply -f bookmyshow-app/service.yml || true

                      # Show pods and services
                      kubectl get pods --all-namespaces || true
                      kubectl get svc --all-namespaces || true
                    '''
                }
            }
            post {
                always {
                    // collect kubectl state for debugging
                    sh 'kubectl get pods -o wide --all-namespaces || true'
                    archiveArtifacts artifacts: 'k8s-*.log', allowEmptyArchive: true
                }
            }
        }
    }

    post {
        always {
            // Attach Trivy output and pipeline log to email
            emailext (
                subject: "BMS Pipeline Build - ${currentBuild.fullDisplayName} - ${currentBuild.currentResult}",
                body: """Build: ${env.BUILD_URL}
Result: ${currentBuild.currentResult}
See Trivy output attached.
""",
                to: "tejastejasa@gmail.com",
                attachLog: true,
                attachmentsPattern: "${TRIVY_OUTPUT}"
            )
        }
    }
}
