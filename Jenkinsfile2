pipeline {
    agent any

    tools {
        nodejs 'node18'
        jdk 'jdk11'
        sonarQube 'sonarserver'
    }

    environment {
        DOCKERHUB_USERNAME = 'tejasgowramma123'
        DOCKERHUB_CREDENTIALS = 'docker-creds'
        AWS_DEFAULT_REGION   = 'us-east-1'
        CLUSTER_NAME         = 'bms-cluster'
        IMAGE_NAME           = 'tejasgowramma123/bookmyshow'
    }

    stages {

        stage('Checkout SCM') {
            steps {
                git 'https://github.com/Tejas886/Book-My-Show-Project-Caps.git'
            }
        }

        stage('Install Dependencies') {
            steps {
                dir('bookmyshow-app') {
                    sh '''
                        echo "Cleaning..."
                        rm -rf node_modules package-lock.json
                        echo "Installing dependencies..."
                        npm install --silent
                    '''
                }
            }
        }

        stage("OWASP FS Scan (FAST MODE)") {
            steps {
                dependencyCheck additionalArguments: '--scan bookmyshow-app --disableAssembly --quick'
            }
        }

        stage('Trivy FS Scan') {
            steps {
                sh 'trivy fs --scanners vuln bookmyshow-app'
            }
        }

        stage('Docker Build & Push') {
            steps {
                script {
                    sh '''
                        echo "Logging into Docker Hub..."
                        echo "${DOCKERHUB_PASSWORD}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin
                        
                        echo "Building Docker image..."
                        docker build -t ${IMAGE_NAME}:latest .

                        echo "Pushing to Docker Hub..."
                        docker push ${IMAGE_NAME}:latest
                    '''
                }
            }
        }

        stage('Configure Kubeconfig') {
            steps {
                sh '''
                    echo "Fetching kubeconfig..."
                    aws eks update-kubeconfig --name ${CLUSTER_NAME} --region ${AWS_DEFAULT_REGION}
                '''
            }
        }

        stage('Deploy to EKS Cluster') {
            steps {
                sh '''
                    echo "Applying Kubernetes manifests..."
                    kubectl apply -f deployment.yml
                    kubectl apply -f service.yml

                    echo "Deployment Status:"
                    kubectl rollout status deployment/bookmyshow-deployment
                '''
            }
        }

    }

    post {
        always {
            emailext(
                to: "tejastejasa@gmail.com",
                subject: "BMS Pipeline - Status: ${currentBuild.currentResult}",
                body: "Pipeline finished with status: ${currentBuild.currentResult}"
            )
        }
    }
}
