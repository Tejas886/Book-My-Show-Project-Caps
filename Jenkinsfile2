pipeline {
    agent any

    tools {
        nodejs 'node16'
        maven 'maven3'
    }

    environment {
        SONARQUBE = credentials('sonar-creds')
        DOCKER_CREDS = credentials('docker-creds')
        AWS_CREDS = credentials('aws-creds')
    }

    stages {

        stage('Clean Workspace') {
            steps {
                cleanWs()
            }
        }

        stage('Checkout Code') {
            steps {
                git 'https://github.com/staragile2016/Book-My-Show.git'
                sh 'ls -la'
            }
        }

        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv('sonarserver') {
                    sh '''
                        /var/lib/jenkins/tools/hudson.plugins.sonar.SonarRunnerInstallation/sonarqube-scanner/bin/sonar-scanner \
                        -Dsonar.projectKey=BMS \
                        -Dsonar.sources=bookmyshow-app \
                        -Dsonar.exclusions=**/node_modules/**
                    '''
                }
            }
        }

        stage('Skip Quality Gate (Fast)') {
            steps {
                echo "Skipping quality gate for faster pipeline."
            }
        }

        stage('Install Dependencies') {
            steps {
                sh '''
                    cd bookmyshow-app
                    rm -rf node_modules package-lock.json
                    npm install --quiet
                '''
            }
        }

        stage('OWASP FS Scan') {
            steps {
                dependencyCheck additionalArguments: '--scan ./bookmyshow-app', odcInstallation: 'owasp'
            }
        }

        stage('Trivy FS Scan') {
            steps {
                sh '''
                    trivy fs --exit-code 0 --severity HIGH,CRITICAL bookmyshow-app
                '''
            }
        }

        stage('Docker Build & Push') {
            steps {
                sh '''
                    docker build -t tejas886/bms:latest .
                    echo "${DOCKER_CREDS_PSW}" | docker login -u "${DOCKER_CREDS_USR}" --password-stdin
                    docker push tejas886/bms:latest
                '''
            }
        }

        stage('Deploy to EKS') {
            steps {
                withAWS(credentials: 'aws-creds', region: 'us-east-1') {
                    sh '''
                        aws eks --region us-east-1 update-kubeconfig --name bookmyshow-eks
                        kubectl apply -f deployment.yml
                        kubectl apply -f service.yml
                        kubectl get pods -o wide
                    '''
                }
            }
        }
    }

    post {
        always {
            echo "Pipeline completed."
        }
    }
}
