pipeline {
    agent any

    // Make sure these Tool names exist in Manage Jenkins -> Global Tool Configuration
    tools {
        jdk 'jdk17'            // replace if your JDK tool name is different
        nodejs 'nodejs25'      // replace if different
    }

    environment {
        SCANNER_HOME = tool 'sonarqube-scanner'        // Sonar scanner tool name
        DOCKER_IMAGE = 'tejasgowramma123/flask-notes-app:2.0'
        EKS_CLUSTER_NAME = 'bookmyshow-eks'
        AWS_REGION = 'us-east-1'
        // credentials ids - update them to match your Jenkins IDs if different
        DOCKER_CREDS_ID = 'docker-creds'
        DEPCHK_INSTALL = 'DP-Check'                    // Dependency-Check installation name in Jenkins (if using plugin). Update if different.
    }

    options {
        // keep only one build at a time to avoid running multiple heavy scans on the same node
        disableConcurrentBuilds()
        // keep build logs for 10 builds
        buildDiscarder(logRotator(numToKeepStr: '10'))
        // timestamps help debug slow stages
        timestamps()
    }

    stages {

        stage('Clean Workspace') {
            steps {
                cleanWs()
            }
        }

        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/staragile2016/Book-My-Show.git'
                sh 'ls -la'
            }
        }

        stage('SonarQube Analysis') {
            steps {
                // run sonar scanner quickly and only scan the app directory
                withEnv(["PATH+NODE=${tool 'nodejs25'}/bin"]) {
                    sh """
                      echo "Running Sonar Scanner..."
                      ${SCANNER_HOME}/bin/sonar-scanner \
                        -Dsonar.projectKey=BMS \
                        -Dsonar.projectName=BMS \
                        -Dsonar.sources=bookmyshow-app \
                        -Dsonar.exclusions=**/node_modules/**,**/*.yml,**/*.yaml \
                        -Dsonar.login=${SONAR_AUTH_TOKEN:-''}
                    """
                }
            }
        }

        stage('Wait Sonar Quality Gate') {
            steps {
                script {
                    // Give Sonar server some time to process the analysis.
                    // Increase if your Sonar server is slow. This does not block other stages, it's a small wait.
                    timeout(time: 3, unit: 'MINUTES') {
                        // If you use the SonarQube plugin with automatic task linking, this will wait.
                        // If not configured, this will quickly fail - it won't block other stages longer than the timeout.
                        def qg = waitForQualityGate abortPipeline: false
                        echo "Quality Gate result: ${qg?.status}"
                    }
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                dir('bookmyshow-app') {
                    sh '''
                    echo "Installing NPM dependencies (quiet)..."
                    rm -rf node_modules package-lock.json
                    npm ci --silent || npm install --silent
                    npm --version
                    node --version
                    '''
                }
            }
            //  keep sensible timeout for npm install so it doesn't hang
            timeout(time: 10, unit: 'MINUTES')
        }

        stage('Security Scans (parallel, bounded)') {
            parallel {
                stage('OWASP Dependency-Check (FAST)') {
                    steps {
                        script {
                            // dependency-check CLI via Jenkins plugin (if configured) or via shell
                            // plugin call:
                            // Make sure you've configured a Dependency-Check installation named as DEPCHK_INSTALL
                            // We run a limited scan (only project folder) and disable assembly analyzer to speed up.
                            timeout(time: 12, unit: 'MINUTES') {
                                // call plugin if available:
                                try {
                                    dependencyCheck additionalArguments: "--scan bookmyshow-app --disableAssembly --format XML --out ./dependency-check-output",
                                                    odcInstallation: "${env.DEPCHK_INSTALL}"
                                    dependencyCheckPublisher pattern: '**/dependency-check-report.xml'
                                } catch (err) {
                                    echo "Dependency-Check plugin run failed or not available; fallback to CLI (if installed) or skip. Error: ${err}"
                                    // fallback: if dependency-check CLI is installed on agent:
                                    sh '''
                                      if command -v dependency-check.sh >/dev/null 2>&1; then
                                        dependency-check.sh --scan bookmyshow-app --disableAssembly --format XML -o dependency-check-output || true
                                      else
                                        echo "dependency-check CLI not available - skipped"
                                      fi
                                    '''
                                }
                            }
                        }
                    }
                }

                stage('Trivy (fast vuln scan)') {
                    steps {
                        script {
                            // Scanning only vuln (not secrets) is faster
                            timeout(time: 6, unit: 'MINUTES') {
                                sh '''
                                if command -v trivy >/dev/null 2>&1; then
                                  echo "Running Trivy (vuln only) on bookmyshow-app ..."
                                  trivy fs --scanners vuln --quiet bookmyshow-app > trivyfs.txt || true
                                else
                                  echo "Trivy not installed on agent - skipping"
                                fi
                                '''
                            }
                        }
                    }
                }
            } // parallel
        }

        stage('Docker Build & Push') {
            steps {
                script {
                    // Use Jenkins stored credentials (username/password) to login to Docker Hub.
                    // Ensure you have a username/password credential with id 'docker-creds'
                    withCredentials([usernamePassword(credentialsId: "${env.DOCKER_CREDS_ID}", usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                        timeout(time: 10, unit: 'MINUTES') {
                            sh '''
                            set -e
                            echo "Docker CLI version:"
                            docker --version || true

                            echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin

                            echo "Building Docker image (no cache)..."
                            docker build --no-cache -t ${DOCKER_IMAGE} -f bookmyshow-app/Dockerfile bookmyshow-app

                            echo "Pushing image to registry..."
                            docker push ${DOCKER_IMAGE} || { echo "docker push failed"; exit 1; }

                            echo "Logout docker"
                            docker logout || true
                            '''
                        }
                    }
                }
            }
        }

        stage('Deploy to EKS Cluster (optional)') {
            when {
                expression { return env.AWS_ACCESS_KEY_ID != null || fileExists('/home/jenkins/.kube/config') }
            }
            steps {
                script {
                    timeout(time: 5, unit: 'MINUTES') {
                        sh '''
                        echo "Verifying AWS authentication..."
                        aws sts get-caller-identity || true

                        echo "Configure kubeconfig for EKS..."
                        aws eks update-kubeconfig --region ${AWS_REGION} --name ${EKS_CLUSTER_NAME} || true

                        echo "Applying manifests..."
                        kubectl apply -f deployment.yml || true
                        kubectl apply -f service.yml || true

                        echo "Listing pods & svc..."
                        kubectl get pods --no-headers || true
                        kubectl get svc || true
                        '''
                    }
                }
            }
        }
    }

    post {
        always {
            script {
                // collect artifacts if present
                sh 'ls -la || true'
            }
            emailext attachLog: true,
                subject: "Build ${currentBuild.currentResult}: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """<p>Job: ${env.JOB_NAME}</p>
                         <p>Build: ${env.BUILD_NUMBER}</p>
                         <p>Result: ${currentBuild.currentResult}</p>
                         <p>See console output: ${env.BUILD_URL}</p>""",
                to: 'tejastejasa@gmail.com'
        }
    }
}
