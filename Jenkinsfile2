pipeline {
    agent any

    tools {
        nodejs 'nodejs25'
        maven 'maven3'
        dockerTool 'docker-latest'
        dependencyCheck 'odc'
        sonarqubeScanner 'sonarqube-scanner'
    }

    environment {
        DOCKER_HUB = credentials('docker-creds')
        AWS_CREDS  = credentials('aws-creds')
        EMAIL_KEY  = credentials('emailkey')
    }

    stages {

        stage('Checkout Code') {
            steps {
                cleanWs()
                git branch: 'main', url: 'https://github.com/Tejas886/Book-My-Show-Project-Caps.git'
            }
        }

        stage('Install Dependencies') {
            steps {
                sh 'npm install --silent'
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    sh """
                       echo "$DOCKER_HUB_PSW" | docker login -u "$DOCKER_HUB_USR" --password-stdin
                       docker build -t tejas886/bookmyshow:latest .
                       docker push tejas886/bookmyshow:latest
                    """
                }
            }
        }

        stage('Deploy to EKS') {
            steps {
                script {

                    sh """
                      aws eks update-kubeconfig \
                         --region us-east-1 \
                         --name bookmyshow-eks \
                         --profile default
                      
                      kubectl set image deployment/bookmyshow bookmyshow=tejas886/bookmyshow:latest
                    """
                }
            }
        }
    }

    post {
        always {
            emailext (
                to: 'tejastejasa@gmail.com',
                subject: "Pipeline Completed",
                body: "The BookMyShow pipeline has finished execution."
            )
        }
    }
}
