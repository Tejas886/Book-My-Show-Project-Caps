pipeline {
    agent any

    tools {
        nodejs 'nodejs25'        // You have this installed
        jdk 'jdk17'              // You have this installed
        maven 'maven3'           // Assuming maven name is maven3
        dependencyCheck 'odc'    // The name of your OWASP installation
        dockerTool 'docker'      // Your installed Docker CLI
    }

    environment {
        DOCKERHUB_USER = "tejasgowramma123"
        IMAGE_NAME     = "bookmyshow-app"
        AWS_DEFAULT_REGION = "us-east-1"
    }

    stages {

        stage('Checkout SCM') {
            steps {
                git 'https://github.com/Tejas886/Book-My-Show-Project-Caps.git'
            }
        }

        stage('Clean Workspace') {
            steps {
                cleanWs()
            }
        }

        stage('Checkout Frontend App') {
            steps {
                git 'https://github.com/staragile2016/Book-My-Show.git'
                sh 'ls -la'
            }
        }

        stage('SonarQube Analysis') {
            environment {
                scannerHome = tool 'sonar-scanner'
            }
            steps {
                withSonarQubeEnv('sonarserver') {
                    sh """
                        ${scannerHome}/bin/sonar-scanner \
                        -Dsonar.projectKey=BMS \
                        -Dsonar.sources=bookmyshow-app \
                        -Dsonar.exclusions=**/node_modules/**
                    """
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                dir('bookmyshow-app') {
                    sh """
                        echo Installing npm dependencies...
                        rm -rf node_modules package-lock.json
                        npm install --quiet
                    """
                }
            }
        }

        stage('OWASP FS Scan (FAST MODE)') {
            steps {
                dependencyCheck additionalArguments: '''
                    --scan bookmyshow-app 
                    --disableAssembly 
                    --quick
                '''
            }
        }

        stage('Trivy FS Scan') {
            steps {
                sh 'trivy fs --scanners vuln bookmyshow-app'
            }
        }

        stage('Docker Build & Push') {
            steps {
                script {

                    sh """
                        echo Logging in to Docker Hub...
                        echo '${env.DOCKERHUB_PASSWORD}' | docker login -u '${env.DOCKERHUB_USER}' --password-stdin
                    """

                    sh """
                        docker build -t ${DOCKERHUB_USER}/${IMAGE_NAME}:latest bookmyshow-app
                        docker push ${DOCKERHUB_USER}/${IMAGE_NAME}:latest
                    """
                }
            }
        }

        stage('Deploy to EKS Cluster') {
            steps {
                sh """
                    aws eks update-kubeconfig --region ${AWS_DEFAULT_REGION} --name bmscluster

                    kubectl set image deployment/bms-deployment \
                        bmscontainer=${DOCKERHUB_USER}/${IMAGE_NAME}:latest

                    kubectl rollout status deployment/bms-deployment
                """
            }
        }
    }

    post {
        always {
            emailext(
                to: "tejastejasa@gmail.com",
                subject: "BMS Pipeline Completed",
                body: "Pipeline completed. Check Jenkins for details."
            )
        }
    }
}
